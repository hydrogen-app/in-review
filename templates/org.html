{{define "title"}}{{.Org.Login}} — ngmi{{end}}

{{define "content"}}
<div class="page-wrap">

  <!-- ── Org Header ── -->
  <div class="user-header">
    {{if .Org.AvatarURL}}
    <img src="{{.Org.AvatarURL}}" class="user-avatar" alt="{{.Org.Login}}" />
    {{end}}
    <div class="user-info">
      <div class="org-type-badge">Organization</div>
      <h1 class="page-title">{{if .Org.Name}}{{.Org.Name}}{{else}}{{.Org.Login}}{{end}}</h1>
      <p class="user-login mono">@{{.Org.Login}}</p>
      {{if .Org.Bio}}<p class="user-bio">{{.Org.Bio}}</p>{{end}}
      <div class="user-meta">
        {{if .TotalMergedPRs}}<span class="meta-item">{{formatNumber .TotalMergedPRs}} merged PRs tracked</span>{{end}}
        {{if .Org.PublicRepos}}<span class="meta-item">{{.Org.PublicRepos}} public repos</span>{{end}}
      </div>
    </div>
    <a href="https://github.com/{{.Org.Login}}" target="_blank" rel="noopener" class="btn btn-outline">GitHub ↗</a>
  </div>

  {{if .TimeChartJSON}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <section class="section">
    <h2 class="section-title">Trends Over Time</h2>
    <p class="chart-hint">Monthly aggregates across all repos in this org.</p>
    <div class="charts-grid charts-grid-2">
      <div class="chart-card">
        <div class="chart-label">PR size over time (lines changed)</div>
        <div class="chart-wrap"><canvas id="tc-size"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Review time over time (hrs)</div>
        <div class="chart-wrap"><canvas id="tc-time"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Changes requested rate over time (%)</div>
        <div class="chart-wrap"><canvas id="tc-crrate"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Merged PRs per month</div>
        <div class="chart-wrap"><canvas id="tc-count"></canvas></div>
      </div>
    </div>
  </section>
  <script>
  (function() {
    var t = {{.TimeChartJSON}};
    if (!t.labels || !t.labels.length) return;
    var tickColor = '#848d97', gridColor = '#30363d';
    var baseX = { ticks: { color: tickColor, font: { size: 11 }, maxRotation: 45 }, grid: { color: gridColor } };
    var baseY = function(cb) {
      return { ticks: { color: tickColor, font: { size: 11 }, callback: cb || null }, grid: { color: gridColor }, beginAtZero: true };
    };
    var lineOpts = {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true, labels: { color: tickColor, font: { size: 11 }, boxWidth: 12 } } },
      elements: { line: { tension: 0.3 }, point: { radius: 2, hoverRadius: 4 } }
    };
    var noLegend = Object.assign({}, lineOpts, { plugins: Object.assign({}, lineOpts.plugins, { legend: { display: false } }) });

    new Chart(document.getElementById('tc-size'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Avg', data: t.avgSize, borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
        { label: 'Median', data: t.medianSize, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
      ]},
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY() } })
    });
    new Chart(document.getElementById('tc-time'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Avg', data: t.avgHours, borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
        { label: 'Median', data: t.medianHours, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
      ]},
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY(function(v) { return v + 'h'; }) } })
    });
    new Chart(document.getElementById('tc-crrate'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Changes requested rate', data: t.changesRequestedRate, borderColor: '#f85149', backgroundColor: '#f8514915', borderWidth: 2, fill: true }
      ]},
      options: Object.assign({}, noLegend, { scales: { x: baseX, y: { min: 0, max: 100, ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } }, grid: { color: gridColor } } } })
    });
    new Chart(document.getElementById('tc-count'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'PRs merged', data: t.prCounts, borderColor: '#58a6ff', backgroundColor: '#58a6ff15', borderWidth: 2, fill: true }
      ]},
      options: Object.assign({}, noLegend, { scales: { x: baseX, y: baseY() } })
    });
  })();
  </script>
  {{end}}

  <!-- ── In-org leaderboards ── -->
  <div class="two-col">

    <div class="col-card">
      <h2 class="col-title">In-Org Review Champions</h2>
      {{if .ReviewerBoard}}
      <div class="board-rows">
        {{range .ReviewerBoard}}
        <a href="/user/{{.Name}}" class="board-row">
          <span class="board-rank {{rankClass .Rank}}">{{rankBadge .Rank}}</span>
          {{if .Extra}}<img src="{{.Extra}}" class="board-avatar" alt="" />{{end}}
          <span class="board-name mono">@{{.Name}}</span>
          <span class="board-val">{{formatNumber .Count}} reviews</span>
        </a>
        {{end}}
      </div>
      {{else}}
      <p class="col-empty">{{if .IsSyncing}}Syncing…{{else}}No review data yet.{{end}}</p>
      {{end}}
    </div>

    <div class="col-card">
      <h2 class="col-title">In-Org Gatekeepers</h2>
      {{if .GatekeeperBoard}}
      <div class="board-rows">
        {{range .GatekeeperBoard}}
        <a href="/user/{{.Name}}" class="board-row">
          <span class="board-rank {{rankClass .Rank}}">{{rankBadge .Rank}}</span>
          {{if .Extra}}<img src="{{.Extra}}" class="board-avatar" alt="" />{{end}}
          <span class="board-name mono">@{{.Name}}</span>
          <span class="board-val warn">{{formatNumber .Count}} blocks</span>
        </a>
        {{end}}
      </div>
      {{else}}
      <p class="col-empty">{{if .IsSyncing}}Syncing…{{else}}No data yet.{{end}}</p>
      {{end}}
    </div>

  </div>

  <!-- ── Org Repos ── -->
  <section class="section">
    <h2 class="section-title">Repos</h2>
    {{if .Repos}}
    <div class="org-repos">
      {{range .Repos}}
      <a href="/repo/{{.FullName}}" class="org-repo-card">
        <div class="org-repo-top">
          <span class="org-repo-name mono">{{.Name}}</span>
          {{if .Language}}<span class="lang-badge sm">{{.Language}}</span>{{end}}
          {{if .Stars}}<span class="stars-badge sm">{{formatNumber .Stars}} stars</span>{{end}}
          {{if .SyncStatus}}
          <span class="sync-badge {{.SyncStatus}} sm">{{.SyncStatus}}</span>
          {{end}}
        </div>
        {{if .Description}}<p class="org-repo-desc">{{.Description}}</p>{{end}}
        {{if .MergedPRCount}}
        <div class="org-repo-stats">
          <span>{{.MergedPRCount}} merged PRs</span>
          <span>·</span>
          <span>avg {{formatDuration .AvgMergeTimeSecs}}</span>
          <span>·</span>
          <span>fastest {{formatDuration .MinMergeTimeSecs}}</span>
        </div>
        {{end}}
      </a>
      {{end}}
    </div>
    {{else}}
    <div class="empty-state">
      <p>Syncing top repos for {{.Org.Login}}… check back in a moment.</p>
    </div>
    {{end}}
  </section>

</div>
{{end}}
