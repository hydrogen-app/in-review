{{define "title"}}Global PR Stats — ngmi{{end}}

{{define "content"}}
<div class="page-wrap">

  <!-- ── Breadcrumb ── -->
  <div class="breadcrumb">
    <a href="/" class="bc-link">ngmi</a>
    <span class="bc-sep">/</span>
    <span class="bc-current">stats</span>
  </div>

  <!-- ── Page Header ── -->
  <div class="repo-header">
    <div class="repo-title-row">
      <h1 class="page-title mono">Global PR Stats</h1>
    </div>
    <p class="repo-desc">Aggregate review data across all tracked repos. How PR size affects review time and how often reviewers request changes.</p>
  </div>

  <!-- ── Summary Cards ── -->
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-card-num">{{formatNumber .Overall.TotalPRs}}</span>
      <span class="stat-card-label">Merged PRs</span>
    </div>
    <div class="stat-card">
      <span class="stat-card-num">{{formatNumber .Overall.TotalRepos}}</span>
      <span class="stat-card-label">Repos Tracked</span>
    </div>
    <div class="stat-card">
      <span class="stat-card-num">{{formatDuration .Overall.AvgSecs}}</span>
      <span class="stat-card-label">Avg Review Time</span>
    </div>
    <div class="stat-card highlight">
      <span class="stat-card-num">{{formatDuration .Overall.MedianSecs}}</span>
      <span class="stat-card-label">Median Review Time</span>
    </div>
  </div>

  {{if or .TimeChartJSON .SizeChartJSON}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <div class="chart-controls">
    {{if .TimeChartJSON}}
    <div class="range-btns" id="range-btns">
      <button class="range-btn active" data-range="0"   onclick="ngmiSetRange(0)">All</button>
      <button class="range-btn"        data-range="3"   onclick="ngmiSetRange(3)">3M</button>
      <button class="range-btn"        data-range="6"   onclick="ngmiSetRange(6)">6M</button>
      <button class="range-btn"        data-range="12"  onclick="ngmiSetRange(12)">1Y</button>
      <button class="range-btn"        data-range="24"  onclick="ngmiSetRange(24)">2Y</button>
      <button class="range-btn"        data-range="60"  onclick="ngmiSetRange(60)">5Y</button>
      <button class="range-btn"        data-range="120" onclick="ngmiSetRange(120)">10Y</button>
    </div>
    {{end}}
    <div class="trim-ctrl">
      <span>Trim top</span>
      <output id="trim-val">{{.Trim}}</output><span>% outliers</span>
      <input type="range" name="trim" id="trim-slider" min="0" max="20" value="{{.Trim}}"
        oninput="document.getElementById('trim-val').textContent=this.value"
        hx-get="/stats"
        hx-trigger="change"
        hx-target="#charts-area"
        hx-select="#charts-area"
        hx-push-url="true"
        hx-include="#min-stars-input,#min-contribs-input">
    </div>
    <div class="filter-group">
      <span>Stars</span>
      <div class="range-btns">
        <button type="button" class="range-btn stars-btn{{if eq .MinStars 0}} active{{end}}"     data-val="0"     onclick="ngmiFilter('stars',0)">Any</button>
        <button type="button" class="range-btn stars-btn{{if eq .MinStars 100}} active{{end}}"   data-val="100"   onclick="ngmiFilter('stars',100)">100+</button>
        <button type="button" class="range-btn stars-btn{{if eq .MinStars 1000}} active{{end}}"  data-val="1000"  onclick="ngmiFilter('stars',1000)">1k+</button>
        <button type="button" class="range-btn stars-btn{{if eq .MinStars 10000}} active{{end}}" data-val="10000" onclick="ngmiFilter('stars',10000)">10k+</button>
      </div>
      <input type="hidden" id="min-stars-input" name="min_stars" value="{{.MinStars}}"
        hx-get="/stats" hx-trigger="change" hx-target="#charts-area" hx-select="#charts-area" hx-push-url="true"
        hx-include="#trim-slider,#min-contribs-input">
    </div>
    <div class="filter-group">
      <span>Contributors</span>
      <div class="range-btns">
        <button type="button" class="range-btn contribs-btn{{if eq .MinContribs 0}} active{{end}}"   data-val="0"   onclick="ngmiFilter('contribs',0)">Any</button>
        <button type="button" class="range-btn contribs-btn{{if eq .MinContribs 5}} active{{end}}"   data-val="5"   onclick="ngmiFilter('contribs',5)">5+</button>
        <button type="button" class="range-btn contribs-btn{{if eq .MinContribs 20}} active{{end}}"  data-val="20"  onclick="ngmiFilter('contribs',20)">20+</button>
        <button type="button" class="range-btn contribs-btn{{if eq .MinContribs 100}} active{{end}}" data-val="100" onclick="ngmiFilter('contribs',100)">100+</button>
      </div>
      <input type="hidden" id="min-contribs-input" name="min_contribs" value="{{.MinContribs}}"
        hx-get="/stats" hx-trigger="change" hx-target="#charts-area" hx-select="#charts-area" hx-push-url="true"
        hx-include="#trim-slider,#min-stars-input">
    </div>
  </div>
  <script>
  function ngmiFilter(type, val) {
    var inputId = type === 'stars' ? 'min-stars-input' : 'min-contribs-input';
    var btnClass = type === 'stars' ? 'stars-btn' : 'contribs-btn';
    document.getElementById(inputId).value = val;
    document.querySelectorAll('.' + btnClass).forEach(function(b) {
      b.classList.toggle('active', parseInt(b.dataset.val) === val);
    });
    htmx.trigger(document.getElementById(inputId), 'change');
  }
  </script>
  <div id="charts-area">
  {{end}}

  <!-- ── Time-Series Charts ── -->
  {{if .TimeChartJSON}}
  <section class="section">
    <h2 class="section-title">Trends Over Time</h2>
    <p class="chart-hint">Monthly aggregates across all tracked repos. The gap between avg and median shows how much outliers skew the data — a widening gap means more extreme PRs.</p>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">PR size over time (lines changed)</div>
        <div class="chart-wrap"><canvas id="tc-size"></canvas></div>
      </div>
      <div class="chart-aside" id="tc-size-aside"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Review time over time (hrs)</div>
        <div class="chart-wrap"><canvas id="tc-time"></canvas></div>
      </div>
      <div class="chart-aside" id="tc-time-aside"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Changes requested rate over time (%)</div>
        <div class="chart-wrap"><canvas id="tc-crrate"></canvas></div>
      </div>
      <div class="chart-aside" id="tc-crrate-aside"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Merged PRs per month</div>
        <div class="chart-wrap"><canvas id="tc-count"></canvas></div>
      </div>
      <div class="chart-aside" id="tc-count-aside"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Time to first review (hrs)</div>
        <div class="chart-wrap"><canvas id="tc-first-review"></canvas></div>
      </div>
      <div class="chart-aside" id="tc-first-review-aside"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Unreviewed merge rate (%)</div>
        <div class="chart-wrap"><canvas id="tc-unreviewed"></canvas></div>
      </div>
      <div class="chart-aside" id="tc-unreviewed-aside"></div>
    </div>
  </section>
  <script>
  (function() {
    var t = {{.TimeChartJSON}};
    if (!t.labels || !t.labels.length) return;

    var tickColor = '#848d97', gridColor = '#30363d';
    var baseX = { ticks: { color: tickColor, font: { size: 11 }, maxRotation: 45 }, grid: { color: gridColor } };
    var baseY = function(cb) {
      var tk = { color: tickColor, font: { size: 11 } };
      if (cb) tk.callback = cb;
      return { ticks: tk, grid: { color: gridColor }, beginAtZero: true };
    };
    var lineOpts = {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true, labels: { color: tickColor, font: { size: 11 }, boxWidth: 12 } } },
      elements: { line: { tension: 0.3 }, point: { radius: 2, hoverRadius: 4 } }
    };
    var noLegend = Object.assign({}, lineOpts, {
      plugins: Object.assign({}, lineOpts.plugins, { legend: { display: false } })
    });

    new Chart(document.getElementById('tc-size'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Avg',    data: t.avgSize,    borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
        { label: 'Median', data: t.medianSize, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
      ]},
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY() } })
    });
    new Chart(document.getElementById('tc-time'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Avg',    data: t.avgHours,    borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
        { label: 'Median', data: t.medianHours, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
      ]},
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY(function(v) { return v + 'h'; }) } })
    });
    new Chart(document.getElementById('tc-crrate'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Changes requested %', data: t.changesRequestedRate, borderColor: '#f85149', backgroundColor: '#f8514915', borderWidth: 2, fill: true }
      ]},
      options: Object.assign({}, noLegend, { scales: { x: baseX, y: { min: 0, max: 100, ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } }, grid: { color: gridColor } } } })
    });
    new Chart(document.getElementById('tc-count'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'PRs merged', data: t.prCounts, borderColor: '#58a6ff', backgroundColor: '#58a6ff15', borderWidth: 2, fill: true }
      ]},
      options: Object.assign({}, noLegend, {
        scales: { x: baseX, y: baseY() },
        plugins: Object.assign({}, noLegend.plugins, {
          tooltip: { callbacks: { afterLabel: function(ctx) {
            var i = ctx.dataIndex;
            if (i === 0) return null;
            var prev = ctx.dataset.data[i - 1];
            if (!prev) return null;
            var pct = Math.round((ctx.dataset.data[i] - prev) / prev * 100);
            return (pct > 0 ? '▲ +' : pct < 0 ? '▼ ' : '→ ') + Math.abs(pct) + '% vs prev month';
          }}}
        })
      })
    });
    new Chart(document.getElementById('tc-first-review'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Avg',    data: t.avgFirstReviewHours, borderColor: '#bc8cff', backgroundColor: '#bc8cff15', borderWidth: 2, fill: false },
        { label: 'Median', data: t.medFirstReviewHours, borderColor: '#a371f7', backgroundColor: '#a371f715', borderWidth: 2, fill: false }
      ]},
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY(function(v) { return v + 'h'; }) } })
    });
    new Chart(document.getElementById('tc-unreviewed'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Unreviewed %', data: t.unreviewedMergeRate, borderColor: '#ffa657', backgroundColor: '#ffa65715', borderWidth: 2, fill: true }
      ]},
      options: Object.assign({}, noLegend, { scales: { x: baseX, y: { min: 0, max: 100, ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } }, grid: { color: gridColor } } } })
    });

    var allCharts = [
      Chart.getChart('tc-size'), Chart.getChart('tc-time'),
      Chart.getChart('tc-crrate'), Chart.getChart('tc-count'),
      Chart.getChart('tc-first-review'), Chart.getChart('tc-unreviewed')
    ];
    var allSeries = [[t.avgSize,t.medianSize],[t.avgHours,t.medianHours],[t.changesRequestedRate],[t.prCounts],[t.avgFirstReviewHours,t.medFirstReviewHours],[t.unreviewedMergeRate]];
    window.ngmiSetRange = function(n) {
      window._ngmiRange = n;
      var start = n > 0 ? Math.max(0, t.labels.length - n) : 0;
      allCharts.forEach(function(c, ci) {
        if (!c) return;
        c.data.labels = t.labels.slice(start);
        allSeries[ci].forEach(function(s, di) { c.data.datasets[di].data = s.slice(start); });
        c.update();
      });
      document.querySelectorAll('.range-btn').forEach(function(btn) {
        btn.classList.toggle('active', parseInt(btn.dataset.range) === n);
      });
    };
    if (window._ngmiRange) window.ngmiSetRange(window._ngmiRange);

    // ── Populate stat sidebars via DOM ──────────────────────────────
    var n = t.labels.length;

    function statCard(numText, labelText, trendText, trendColor) {
      var div = document.createElement('div');
      div.className = 'chart-stat';
      var num = document.createElement('span');
      num.className = 'chart-stat-num';
      num.textContent = numText;
      var lbl = document.createElement('span');
      lbl.className = 'chart-stat-label';
      lbl.textContent = labelText;
      div.appendChild(num);
      div.appendChild(lbl);
      if (trendText) {
        var tr = document.createElement('span');
        tr.className = 'chart-stat-trend';
        tr.style.color = trendColor;
        tr.textContent = trendText;
        div.appendChild(tr);
      }
      return div;
    }

    function trendCard(fAvg, lAvg, fMed, lMed, fn) {
      var d = document.createElement('div'); d.className = 'chart-stat';
      var any = false;
      if (fAvg && fAvg !== 0) {
        var pA = Math.round((lAvg - fAvg) / fAvg * 100);
        var sA = document.createElement('span'); sA.className = 'chart-stat-num';
        sA.textContent = (pA > 0 ? '▲ ' : pA < 0 ? '▼ ' : '→ ') + Math.abs(pA) + '% avg';
        d.appendChild(sA); any = true;
      }
      if (fMed && fMed !== 0) {
        var pM = Math.round((lMed - fMed) / fMed * 100);
        var sM = document.createElement('span'); sM.className = 'chart-stat-num';
        sM.textContent = (pM > 0 ? '▲ ' : pM < 0 ? '▼ ' : '→ ') + Math.abs(pM) + '% median';
        d.appendChild(sM); any = true;
      }
      if (!any) return null;
      var lbl = document.createElement('span'); lbl.className = 'chart-stat-label';
      lbl.textContent = 'since ' + fn;
      d.appendChild(lbl);
      return d;
    }

    function populateAside(id, cards) {
      var aside = document.getElementById(id);
      cards.forEach(function(c) { if (c) aside.appendChild(c); });
    }

    var first = t.labels[0], latest = t.labels[n - 1];

    populateAside('tc-size-aside', [
      statCard(Math.round(t.avgSize[n-1]) + ' lines',    'Avg size, ' + latest),
      statCard(Math.round(t.medianSize[n-1]) + ' lines', 'Median size, ' + latest),
      trendCard(t.avgSize[0], t.avgSize[n-1], t.medianSize[0], t.medianSize[n-1], first)
    ]);
    populateAside('tc-time-aside', [
      statCard(t.avgHours[n-1] + 'h',    'Avg review time, ' + latest),
      statCard(t.medianHours[n-1] + 'h', 'Median review time, ' + latest),
      trendCard(t.avgHours[0], t.avgHours[n-1], t.medianHours[0], t.medianHours[n-1], first)
    ]);
    populateAside('tc-crrate-aside', [
      statCard(t.changesRequestedRate[n-1] + '%', 'Rate, ' + latest),
      statCard(t.changesRequestedRate[0] + '%',   'Rate, ' + first),
      trendCard(t.changesRequestedRate[0], t.changesRequestedRate[n-1], 0, 0, first)
    ]);
    populateAside('tc-count-aside', [
      statCard(t.prCounts[n-1] + ' PRs', 'Merged, ' + latest),
      statCard(Math.max.apply(null, t.prCounts) + ' PRs', 'Peak month'),
      trendCard(t.prCounts[0], t.prCounts[n-1], 0, 0, first)
    ]);
    populateAside('tc-first-review-aside', [
      statCard(t.avgFirstReviewHours[n-1] + 'h', 'Avg first review, ' + latest),
      statCard(t.medFirstReviewHours[n-1] + 'h', 'Median first review, ' + latest),
      trendCard(t.avgFirstReviewHours[0], t.avgFirstReviewHours[n-1], t.medFirstReviewHours[0], t.medFirstReviewHours[n-1], first)
    ]);
    populateAside('tc-unreviewed-aside', [
      statCard(t.unreviewedMergeRate[n-1] + '%', 'Unreviewed, ' + latest),
      statCard(t.unreviewedMergeRate[0] + '%', 'Unreviewed, ' + first),
      trendCard(t.unreviewedMergeRate[0], t.unreviewedMergeRate[n-1], 0, 0, first)
    ]);
  })();
  </script>
  {{end}}

  <!-- ── PR Size Charts ── -->
  {{if .SizeChartJSON}}
  <section class="section">
    <h2 class="section-title">PR Size vs Review Time</h2>
    <p class="chart-hint">Lines changed (additions + deletions) grouped into size buckets.</p>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Avg review time by size (hrs)</div>
        <div class="chart-wrap"><canvas id="chart-avg-time"></canvas></div>
      </div>
      <div class="chart-aside" id="aside-avg-time"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Median review time by size (hrs)</div>
        <div class="chart-wrap"><canvas id="chart-median-time"></canvas></div>
      </div>
      <div class="chart-aside" id="aside-median-time"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">PRs by size bucket</div>
        <div class="chart-wrap"><canvas id="chart-count"></canvas></div>
      </div>
      <div class="chart-aside" id="aside-count"></div>
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">PR Size vs Changes Requested</h2>
    <p class="chart-hint">"Changes requested rate" is the share of PRs that received at least one blocking review.</p>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Changes requested rate by size (%)</div>
        <div class="chart-wrap"><canvas id="chart-cr-rate"></canvas></div>
      </div>
      <div class="chart-aside" id="aside-cr-rate"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Avg changes requested per PR by size</div>
        <div class="chart-wrap"><canvas id="chart-cr-avg"></canvas></div>
      </div>
      <div class="chart-aside" id="aside-cr-avg"></div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <div class="chart-label">Clean approval rate by size (%)</div>
        <div class="chart-wrap"><canvas id="chart-approval"></canvas></div>
      </div>
      <div class="chart-aside" id="aside-approval"></div>
    </div>
  </section>

  <script>
  (function() {
    var d = {{.SizeChartJSON}};
    if (!d.labels || !d.labels.length) return;

    var tickColor = '#848d97', gridColor = '#30363d';
    var baseScales = {
      x: { ticks: { color: tickColor, font: { size: 11 } }, grid: { color: gridColor } },
      y: { ticks: { color: tickColor, font: { size: 11 } }, grid: { color: gridColor }, beginAtZero: true }
    };
    var hourScales = { x: baseScales.x, y: { ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + 'h'; } }, grid: { color: gridColor }, beginAtZero: true } };
    var pctScales  = { x: baseScales.x, y: { min: 0, max: 100, ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } }, grid: { color: gridColor } } };
    var opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

    new Chart(document.getElementById('chart-avg-time'),    { type: 'bar', data: { labels: d.labels, datasets: [{ data: d.avgHours,            backgroundColor: '#d2992233', borderColor: '#d29922', borderWidth: 1 }] }, options: Object.assign({}, opts, { scales: hourScales }) });
    new Chart(document.getElementById('chart-median-time'), { type: 'bar', data: { labels: d.labels, datasets: [{ data: d.medianHours,         backgroundColor: '#f0883e33', borderColor: '#f0883e', borderWidth: 1 }] }, options: Object.assign({}, opts, { scales: hourScales }) });
    new Chart(document.getElementById('chart-count'),       { type: 'bar', data: { labels: d.labels, datasets: [{ data: d.prCounts,            backgroundColor: '#58a6ff33', borderColor: '#58a6ff', borderWidth: 1 }] }, options: Object.assign({}, opts, { scales: baseScales }) });
    new Chart(document.getElementById('chart-cr-rate'),     { type: 'bar', data: { labels: d.labels, datasets: [{ data: d.changesRequestedRate,backgroundColor: '#f8514933', borderColor: '#f85149', borderWidth: 1 }] }, options: Object.assign({}, opts, { scales: pctScales }) });
    new Chart(document.getElementById('chart-cr-avg'),      { type: 'bar', data: { labels: d.labels, datasets: [{ data: d.avgChangesRequested, backgroundColor: '#da3633aa', borderColor: '#da3633', borderWidth: 1 }] }, options: Object.assign({}, opts, { scales: baseScales }) });
    new Chart(document.getElementById('chart-approval'),    { type: 'bar', data: { labels: d.labels, datasets: [{ data: d.approvalRate,        backgroundColor: '#3fb95033', borderColor: '#3fb950', borderWidth: 1 }] }, options: Object.assign({}, opts, { scales: pctScales }) });

    // ── Populate bucket sidebars via DOM ────────────────────────────
    function bucketTable(vals, suffix) {
      var table = document.createElement('table');
      table.className = 'bucket-tbl';
      for (var i = 0; i < d.labels.length; i++) {
        var tr = document.createElement('tr');
        var td1 = document.createElement('td');
        td1.textContent = d.labels[i];
        var td2 = document.createElement('td');
        td2.textContent = vals[i] + (suffix || '');
        tr.appendChild(td1);
        tr.appendChild(td2);
        table.appendChild(tr);
      }
      return table;
    }

    document.getElementById('aside-avg-time').appendChild(bucketTable(d.avgHours, 'h'));
    document.getElementById('aside-median-time').appendChild(bucketTable(d.medianHours, 'h'));
    document.getElementById('aside-count').appendChild(bucketTable(d.prCounts, ' PRs'));
    document.getElementById('aside-cr-rate').appendChild(bucketTable(d.changesRequestedRate, '%'));
    document.getElementById('aside-cr-avg').appendChild(bucketTable(d.avgChangesRequested, '×'));
    document.getElementById('aside-approval').appendChild(bucketTable(d.approvalRate, '%'));
  })();
  </script>
  {{else}}
  <div class="empty-state">
    <p>No data yet. Repos need to be synced before stats appear. Add a repo at <a href="/">the homepage</a>.</p>
  </div>
  {{end}}

  {{if or .TimeChartJSON .SizeChartJSON}}
  </div>{{/* end #charts-area */}}
  {{end}}

</div>
{{end}}
