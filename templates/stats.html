{{define "title"}}Global PR Stats — ngmi{{end}}

{{define "content"}}
<div class="page-wrap">

  <!-- ── Breadcrumb ── -->
  <div class="breadcrumb">
    <a href="/" class="bc-link">ngmi</a>
    <span class="bc-sep">/</span>
    <span class="bc-current">stats</span>
  </div>

  <!-- ── Page Header ── -->
  <div class="repo-header">
    <div class="repo-title-row">
      <h1 class="page-title mono">Global PR Stats</h1>
    </div>
    <p class="repo-desc">Aggregate review data across all tracked repos. How PR size affects review time and how often reviewers request changes.</p>
  </div>

  <!-- ── Summary Cards ── -->
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-card-num">{{formatNumber .Overall.TotalPRs}}</span>
      <span class="stat-card-label">Merged PRs</span>
    </div>
    <div class="stat-card">
      <span class="stat-card-num">{{formatNumber .Overall.TotalRepos}}</span>
      <span class="stat-card-label">Repos Tracked</span>
    </div>
    <div class="stat-card">
      <span class="stat-card-num">{{formatDuration .Overall.AvgSecs}}</span>
      <span class="stat-card-label">Avg Review Time</span>
    </div>
    <div class="stat-card highlight">
      <span class="stat-card-num">{{formatDuration .Overall.MedianSecs}}</span>
      <span class="stat-card-label">Median Review Time</span>
    </div>
  </div>

  {{if or .TimeChartJSON .SizeChartJSON}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  {{end}}

  <!-- ── Time-Series Charts ── -->
  {{if .TimeChartJSON}}
  <section class="section">
    <h2 class="section-title">Trends Over Time</h2>
    <p class="chart-hint">Monthly aggregates across all tracked repos. The gap between average and median reveals how skewed the distribution is — a widening gap means more extreme outliers.</p>

    <div class="charts-grid charts-grid-2">
      <div class="chart-card">
        <div class="chart-label">PR size over time (lines changed)</div>
        <div class="chart-wrap"><canvas id="tc-size"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Review time over time (hrs)</div>
        <div class="chart-wrap"><canvas id="tc-time"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Changes requested rate over time (%)</div>
        <div class="chart-wrap"><canvas id="tc-crrate"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Merged PRs per month</div>
        <div class="chart-wrap"><canvas id="tc-count"></canvas></div>
      </div>
    </div>
  </section>
  <script>
  (function() {
    var t = {{.TimeChartJSON}};
    if (!t.labels || !t.labels.length) return;

    var tickColor = '#848d97';
    var gridColor = '#30363d';
    var baseX = { ticks: { color: tickColor, font: { size: 11 }, maxRotation: 45 }, grid: { color: gridColor } };
    var baseY = function(cb) {
      return { ticks: { color: tickColor, font: { size: 11 }, callback: cb || null }, grid: { color: gridColor }, beginAtZero: true };
    };
    var lineOpts = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true, labels: { color: tickColor, font: { size: 11 }, boxWidth: 12 } } },
      elements: { line: { tension: 0.3 }, point: { radius: 2, hoverRadius: 4 } }
    };

    new Chart(document.getElementById('tc-size'), {
      type: 'line',
      data: {
        labels: t.labels,
        datasets: [
          { label: 'Avg', data: t.avgSize, borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
          { label: 'Median', data: t.medianSize, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
        ]
      },
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY() } })
    });

    new Chart(document.getElementById('tc-time'), {
      type: 'line',
      data: {
        labels: t.labels,
        datasets: [
          { label: 'Avg', data: t.avgHours, borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
          { label: 'Median', data: t.medianHours, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
        ]
      },
      options: Object.assign({}, lineOpts, {
        scales: { x: baseX, y: baseY(function(v) { return v + 'h'; }) }
      })
    });

    new Chart(document.getElementById('tc-crrate'), {
      type: 'line',
      data: {
        labels: t.labels,
        datasets: [
          { label: 'Changes requested rate', data: t.changesRequestedRate, borderColor: '#f85149', backgroundColor: '#f8514915', borderWidth: 2, fill: true }
        ]
      },
      options: Object.assign({}, lineOpts, {
        plugins: Object.assign({}, lineOpts.plugins, { legend: Object.assign({}, lineOpts.plugins.legend, { display: false }) }),
        scales: { x: baseX, y: { min: 0, max: 100, ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } }, grid: { color: gridColor } } }
      })
    });

    new Chart(document.getElementById('tc-count'), {
      type: 'line',
      data: {
        labels: t.labels,
        datasets: [
          { label: 'PRs merged', data: t.prCounts, borderColor: '#58a6ff', backgroundColor: '#58a6ff15', borderWidth: 2, fill: true }
        ]
      },
      options: Object.assign({}, lineOpts, {
        plugins: Object.assign({}, lineOpts.plugins, { legend: Object.assign({}, lineOpts.plugins.legend, { display: false }) }),
        scales: { x: baseX, y: baseY() }
      })
    });
  })();
  </script>
  {{end}}

  <!-- ── PR Size Charts ── -->
  {{if .SizeChartJSON}}
  <section class="section">
    <h2 class="section-title">PR Size vs Review Time</h2>
    <p class="chart-hint">Lines changed (additions + deletions) grouped into size buckets. Median is more robust to outliers than average.</p>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-label">Avg review time (hrs)</div>
        <div class="chart-wrap"><canvas id="chart-avg-time"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Median review time (hrs)</div>
        <div class="chart-wrap"><canvas id="chart-median-time"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">PRs by size</div>
        <div class="chart-wrap"><canvas id="chart-count"></canvas></div>
      </div>
    </div>
  </section>

  <section class="section">
    <h2 class="section-title">PR Size vs Changes Requested</h2>
    <p class="chart-hint">How often reviewers push back based on PR size. "Changes requested rate" is the share of PRs that received at least one blocking review.</p>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-label">Changes requested rate (%)</div>
        <div class="chart-wrap"><canvas id="chart-cr-rate"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Avg changes requested (per PR)</div>
        <div class="chart-wrap"><canvas id="chart-cr-avg"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Clean approval rate (%)</div>
        <div class="chart-wrap"><canvas id="chart-approval"></canvas></div>
      </div>
    </div>
  </section>

  <script>
  (function() {
    var d = {{.SizeChartJSON}};
    if (!d.labels || !d.labels.length) return;

    var tickColor = '#848d97';
    var gridColor = '#30363d';
    var baseScales = {
      x: { ticks: { color: tickColor, font: { size: 11 } }, grid: { color: gridColor } },
      y: { ticks: { color: tickColor, font: { size: 11 } }, grid: { color: gridColor }, beginAtZero: true }
    };
    var hourScales = {
      x: baseScales.x,
      y: {
        ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + 'h'; } },
        grid: { color: gridColor }, beginAtZero: true
      }
    };
    var pctScales = {
      x: baseScales.x,
      y: {
        min: 0, max: 100,
        ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } },
        grid: { color: gridColor }
      }
    };
    var opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

    new Chart(document.getElementById('chart-avg-time'), {
      type: 'bar',
      data: { labels: d.labels, datasets: [{ data: d.avgHours, backgroundColor: '#d2992233', borderColor: '#d29922', borderWidth: 1 }] },
      options: Object.assign({}, opts, { scales: hourScales })
    });

    new Chart(document.getElementById('chart-median-time'), {
      type: 'bar',
      data: { labels: d.labels, datasets: [{ data: d.medianHours, backgroundColor: '#f0883e33', borderColor: '#f0883e', borderWidth: 1 }] },
      options: Object.assign({}, opts, { scales: hourScales })
    });

    new Chart(document.getElementById('chart-count'), {
      type: 'bar',
      data: { labels: d.labels, datasets: [{ data: d.prCounts, backgroundColor: '#58a6ff33', borderColor: '#58a6ff', borderWidth: 1 }] },
      options: Object.assign({}, opts, { scales: baseScales })
    });

    new Chart(document.getElementById('chart-cr-rate'), {
      type: 'bar',
      data: { labels: d.labels, datasets: [{ data: d.changesRequestedRate, backgroundColor: '#f8514933', borderColor: '#f85149', borderWidth: 1 }] },
      options: Object.assign({}, opts, { scales: pctScales })
    });

    new Chart(document.getElementById('chart-cr-avg'), {
      type: 'bar',
      data: { labels: d.labels, datasets: [{ data: d.avgChangesRequested, backgroundColor: '#da3633aa', borderColor: '#da3633', borderWidth: 1 }] },
      options: Object.assign({}, opts, { scales: baseScales })
    });

    new Chart(document.getElementById('chart-approval'), {
      type: 'bar',
      data: { labels: d.labels, datasets: [{ data: d.approvalRate, backgroundColor: '#3fb95033', borderColor: '#3fb950', borderWidth: 1 }] },
      options: Object.assign({}, opts, { scales: pctScales })
    });
  })();
  </script>
  {{else}}
  <div class="empty-state">
    <p>No data yet. Repos need to be synced before stats appear. Add a repo at <a href="/">the homepage</a>.</p>
  </div>
  {{end}}

</div>
{{end}}
