{{define "title"}}{{.Repo.FullName}} — ngmi{{end}}

{{define "content"}}
<div class="page-wrap">

  <!-- ── Breadcrumb ── -->
  <div class="breadcrumb">
    <a href="/" class="bc-link">ngmi</a>
    <span class="bc-sep">/</span>
    <a href="/user/{{.Repo.Owner}}" class="bc-link">{{.Repo.Owner}}</a>
    <span class="bc-sep">/</span>
    <span class="bc-current">{{.Repo.Name}}</span>
  </div>

  <!-- ── Repo Header ── -->
  <div class="repo-header">
    <div class="repo-title-row">
      <h1 class="page-title mono">{{.Repo.FullName}}</h1>
      {{if .Repo.Language}}
      <span class="lang-badge">{{.Repo.Language}}</span>
      {{end}}
      {{if .Repo.Stars}}
      <span class="stars-badge">{{formatNumber .Repo.Stars}} stars</span>
      {{end}}
    </div>
    {{if .Repo.Description}}
    <p class="repo-desc">{{.Repo.Description}}</p>
    {{end}}

    <!-- Sync status -->
    <div class="sync-row">
      {{if .IsSyncing}}
      <span
        class="sync-badge syncing"
        hx-get="/api/sync-status/{{.Repo.Owner}}/{{.Repo.Name}}"
        hx-trigger="every 2s"
        hx-swap="outerHTML"
      >⟳ Syncing…</span>
      {{else}}
      <span class="sync-badge done">✓ Synced {{timeAgo .Repo.LastSynced}}</span>
      {{end}}
      <button
        class="btn btn-sm"
        hx-post="/api/sync/{{.Repo.Owner}}/{{.Repo.Name}}"
        hx-swap="none"
        hx-on::after-request="window.location.reload()"
      >↻ Sync Now</button>
      {{if .ShareURL}}
      <a href="{{.ShareURL}}" target="_blank" rel="noopener" class="btn btn-sm btn-outline">Share on X →</a>
      {{end}}
    </div>
    <!-- README badge snippet -->
    <div class="badge-snippet-wrap">
      <span class="badge-snippet-label">README badge:</span>
      <code class="badge-snippet">[![ngmi](https://ngmi.review/badge/{{.Repo.Owner}}/{{.Repo.Name}}.svg)](https://ngmi.review/repo/{{.Repo.Owner}}/{{.Repo.Name}})</code>
      <button class="btn btn-sm btn-outline" onclick="navigator.clipboard.writeText(this.previousElementSibling.textContent)">Copy</button>
    </div>
  </div>

  <!-- ── Stats Grid ── -->
  <div class="stats-grid">
    <div class="stat-card">
      <span class="stat-card-num">{{formatNumber .Repo.MergedPRCount}}</span>
      <span class="stat-card-label">Merged PRs</span>
    </div>
    <div class="stat-card">
      <span class="stat-card-num">{{formatDuration .Repo.AvgMergeTimeSecs}}</span>
      <span class="stat-card-label">Avg Merge Time</span>
    </div>
    <div class="stat-card">
      <span class="stat-card-num speed">{{formatDuration .Repo.MinMergeTimeSecs}}</span>
      <span class="stat-card-label">Fastest PR</span>
    </div>
    <div class="stat-card">
      <span class="stat-card-num slow">{{formatDuration .Repo.MaxMergeTimeSecs}}</span>
      <span class="stat-card-label">Slowest PR</span>
    </div>
    {{if .SpeedRank}}
    <div class="stat-card highlight">
      <span class="stat-card-num">#{{.SpeedRank}}</span>
      <span class="stat-card-label">Global Speed Rank</span>
    </div>
    {{end}}
  </div>

  {{if or .SizeChartJSON .TimeChartJSON}}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  {{end}}

  <!-- ── Trends Over Time ── -->
  {{if .TimeChartJSON}}
  <section class="section">
    <h2 class="section-title">Trends Over Time</h2>
    <p class="chart-hint">Monthly aggregates for this repo. The gap between average and median shows how much outliers are skewing the data.</p>
    <div class="charts-grid charts-grid-2">
      <div class="chart-card">
        <div class="chart-label">PR size over time (lines changed)</div>
        <div class="chart-wrap"><canvas id="tc-size"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Review time over time (hrs)</div>
        <div class="chart-wrap"><canvas id="tc-time"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Changes requested rate over time (%)</div>
        <div class="chart-wrap"><canvas id="tc-crrate"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Merged PRs per month</div>
        <div class="chart-wrap"><canvas id="tc-count"></canvas></div>
      </div>
    </div>
  </section>
  <script>
  (function() {
    var t = {{.TimeChartJSON}};
    if (!t.labels || !t.labels.length) return;
    var tickColor = '#848d97', gridColor = '#30363d';
    var baseX = { ticks: { color: tickColor, font: { size: 11 }, maxRotation: 45 }, grid: { color: gridColor } };
    var baseY = function(cb) {
      return { ticks: { color: tickColor, font: { size: 11 }, callback: cb || null }, grid: { color: gridColor }, beginAtZero: true };
    };
    var lineOpts = {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true, labels: { color: tickColor, font: { size: 11 }, boxWidth: 12 } } },
      elements: { line: { tension: 0.3 }, point: { radius: 2, hoverRadius: 4 } }
    };
    var noLegend = Object.assign({}, lineOpts, { plugins: Object.assign({}, lineOpts.plugins, { legend: { display: false } }) });

    new Chart(document.getElementById('tc-size'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Avg', data: t.avgSize, borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
        { label: 'Median', data: t.medianSize, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
      ]},
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY() } })
    });
    new Chart(document.getElementById('tc-time'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Avg', data: t.avgHours, borderColor: '#d29922', backgroundColor: '#d2992215', borderWidth: 2, fill: false },
        { label: 'Median', data: t.medianHours, borderColor: '#f0883e', backgroundColor: '#f0883e15', borderWidth: 2, fill: false }
      ]},
      options: Object.assign({}, lineOpts, { scales: { x: baseX, y: baseY(function(v) { return v + 'h'; }) } })
    });
    new Chart(document.getElementById('tc-crrate'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'Changes requested rate', data: t.changesRequestedRate, borderColor: '#f85149', backgroundColor: '#f8514915', borderWidth: 2, fill: true }
      ]},
      options: Object.assign({}, noLegend, { scales: { x: baseX, y: { min: 0, max: 100, ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } }, grid: { color: gridColor } } } })
    });
    new Chart(document.getElementById('tc-count'), {
      type: 'line',
      data: { labels: t.labels, datasets: [
        { label: 'PRs merged', data: t.prCounts, borderColor: '#58a6ff', backgroundColor: '#58a6ff15', borderWidth: 2, fill: true }
      ]},
      options: Object.assign({}, noLegend, { scales: { x: baseX, y: baseY() } })
    });
  })();
  </script>
  {{end}}

  <!-- ── PR Size Charts ── -->
  {{if .SizeChartJSON}}
  <section class="section">
    <h2 class="section-title">PR Size Analysis</h2>
    <p class="chart-hint">Lines changed (additions + deletions) vs review outcomes. Re-sync to populate data for older PRs.</p>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-label">PRs by size</div>
        <div class="chart-wrap"><canvas id="chart-count"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Avg review time (hrs)</div>
        <div class="chart-wrap"><canvas id="chart-time"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-label">Clean approval rate (%)</div>
        <div class="chart-wrap"><canvas id="chart-approval"></canvas></div>
      </div>
    </div>
  </section>
  <script>
  (function() {
    var d = {{.SizeChartJSON}};
    if (!d.labels || !d.labels.length) return;

    var tickColor  = '#848d97';
    var gridColor  = '#30363d';
    var baseScales = {
      x: { ticks: { color: tickColor, font: { size: 11 } }, grid: { color: gridColor } },
      y: { ticks: { color: tickColor, font: { size: 11 } }, grid: { color: gridColor }, beginAtZero: true }
    };

    new Chart(document.getElementById('chart-count'), {
      type: 'bar',
      data: {
        labels: d.labels,
        datasets: [{ data: d.prCounts, backgroundColor: '#58a6ff33', borderColor: '#58a6ff', borderWidth: 1 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: baseScales }
    });

    new Chart(document.getElementById('chart-time'), {
      type: 'bar',
      data: {
        labels: d.labels,
        datasets: [{ data: d.avgHours, backgroundColor: '#d2992233', borderColor: '#d29922', borderWidth: 1 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: {
          x: baseScales.x,
          y: { ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + 'h'; } }, grid: { color: gridColor }, beginAtZero: true }
        }
      }
    });

    new Chart(document.getElementById('chart-approval'), {
      type: 'bar',
      data: {
        labels: d.labels,
        datasets: [{ data: d.approvalRate, backgroundColor: '#3fb95033', borderColor: '#3fb950', borderWidth: 1 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
        scales: {
          x: baseScales.x,
          y: { min: 0, max: 100, ticks: { color: tickColor, font: { size: 11 }, callback: function(v) { return v + '%'; } }, grid: { color: gridColor } }
        }
      }
    });
  })();
  </script>
  {{end}}

  <!-- ── Top Reviewers ── -->
  {{if .TopReviewers}}
  <section class="section">
    <h2 class="section-title">Top Reviewers</h2>
    <div class="reviewer-list">
      {{range $i, $r := .TopReviewers}}
      <a href="/user/{{$r.Login}}" class="reviewer-row">
        <span class="reviewer-rank {{rankClass (add $i 1)}}">{{rankBadge (add $i 1)}}</span>
        {{if $r.AvatarURL}}
        <img src="{{$r.AvatarURL}}" class="reviewer-avatar" alt="@{{$r.Login}}" />
        {{end}}
        <div class="reviewer-info">
          <span class="reviewer-name mono">@{{$r.Login}}</span>
          <div class="reviewer-stats">
            <span class="badge badge-blue">{{$r.TotalReviews}} reviews</span>
            {{if $r.Approvals}}<span class="badge badge-green">✓ {{$r.Approvals}} approved</span>{{end}}
            {{if $r.ChangesRequested}}<span class="badge badge-red">↺ {{$r.ChangesRequested}} blocked</span>{{end}}
          </div>
        </div>
        <div class="reviewer-bars">
          <div class="mini-bar">
            <div class="mini-bar-fill green" style="width:{{percent $r.Approvals $r.TotalReviews}}%"></div>
          </div>
        </div>
      </a>
      {{end}}
    </div>
  </section>
  {{end}}

  <!-- ── Recent PRs ── -->
  {{if .RecentPRs}}
  <section class="section">
    <h2 class="section-title">Recent Merged PRs</h2>
    <div class="pr-table-wrap">
      <table class="pr-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Title</th>
            <th>Author</th>
            <th>Time</th>
            <th>Reviews</th>
            <th>Blocks</th>
          </tr>
        </thead>
        <tbody>
          {{range .RecentPRs}}
          <tr class="pr-row">
            <td class="pr-num mono">#{{.Number}}</td>
            <td class="pr-title">
              <a href="https://github.com/{{.RepoFullName}}/pull/{{.Number}}" target="_blank" rel="noopener" class="pr-link">
                {{.Title}}
              </a>
            </td>
            <td class="pr-author">
              <a href="/user/{{.AuthorLogin}}" class="pr-author-link mono">@{{.AuthorLogin}}</a>
            </td>
            <td class="pr-time">
              {{if .MergeTimeSecs}}
              <span class="time-chip {{if lt (deref64 .MergeTimeSecs) 86400}}speed{{else if gt (deref64 .MergeTimeSecs) 2592000}}slow{{end}}">
                {{formatDuration (deref64 .MergeTimeSecs)}}
              </span>
              {{else}}—{{end}}
            </td>
            <td class="pr-reviews">{{.ReviewCount}}</td>
            <td class="pr-blocks">
              {{if .ChangesRequestedCount}}
              <span class="badge badge-red">{{.ChangesRequestedCount}}×</span>
              {{else}}
              <span class="badge badge-green">✓</span>
              {{end}}
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>
  </section>
  {{end}}

  {{if and (eq (len .RecentPRs) 0) (not .IsSyncing)}}
  <div class="empty-state">
    <p>No data yet. Sync is in progress — check back in a moment.</p>
  </div>
  {{end}}

</div>
{{end}}
